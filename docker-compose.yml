version: '3.4'

services:
  api:
    image: webdevops/php-nginx:alpine-php7
    restart: ${SERVICES_RESTART}
    working_dir: /var/www
    depends_on:
      - mysql
    volumes:
      - ${SOURCE_DIR}/src:/var/www
    environment:
      - WEB_DOCUMENT_ROOT=/var/www/public
      - WEB_DOCUMENT_INDEX=index.php
      - WEB_ALIAS_DOMAIN=localhost
      - APP_URL=${API_DOMAIN}
    ports:
      - 443:443
    networks:
      - pureftpd

  ftp:
    build: ftp/.
    restart: ${SERVICES_RESTART}
    depends_on:
      - mysql
    environment:
      - LOCAL_CERT=true
      - CHANGE=8
    volumes:
      - ftp_config:/etc/pureftpd
      - ftp_data:/var/ftp-data
      - tls_cert:/etc/ssl/private/
    ports:
      - 20-21:20-21
      - 30000-30099:30000-30099
    networks:
      - pureftpd


  mysql:
    image: mariadb:10.3
    restart: ${SERVICES_RESTART}
    volumes:
      - db_data:/var/lib/mysql
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=yes
      - MYSQL_DATABASE=pureftpd
      - MYSQL_USER=pure
      - MYSQL_PASSWORD=pure
# only allow exposed port for debug!
    ports:
      - 3306:3306
    networks:
      - pureftpd


  certbot:
    image: webdevops/certbot
    restart: "no"
    volumes: 
      - tls_cert:/etc/letsencrypt
    ports:
      - 80:80
    command: [      
      "/usr/bin/certbot",
      "certonly",
      "--agree-tos",
      "--standalone",
      "--preferred-challenges", "http",
      "-d ${CERTBOT_DOMAIN}",
      "-m ${CERTBOT_EMAIL}",
      "--dry-run"
      ]


networks:
  pureftpd:


volumes:

# service pureftpd
  ftp_config:
    driver: local
    driver_opts:
      type: 'none'
      o: 'bind'
      device: ${CONFIG_DIR}/pureftpd
  ftp_data:
#    driver: local
#    driver_opts:
#      type: 'none'
#      o: 'bind'
#      device: ${FTP_DATA_DIR}


# service db
  db_data:
#    driver: local
#    driver_opts:
#      type: 'none'
#      o: 'bind'
#      device: ${DB_DATA_DIR}

# shared
  tls_cert:
#    driver: local
#    driver_opts:
#      type: 'none'
#      o: 'bind'
#      device: ${TLS_CERT_DIR}